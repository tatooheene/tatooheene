---
title: "Discounting with tatooheene"
author: "The tatooheene team"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
vignette: >
  %\VignetteIndexEntry{Discounting with tatooheene}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, comment = "#>", fig.width = 7, fig.height = 4, dpi = 120
)
library(tatooheene)
```

## What this vignette covers

-   What **discounting** is and where it lives in `tatooheene::df_fp`
-   How to call `discount_value()` and `discount_stream()`and how to interpret the outputs.

## Background

Costs and health outcomes that are expected to occur in the future are generally valued less than those that occur in the present, and so it is recommended that they be discounted in economic analyses. In the Netherlands, we use a discount rate of 1.5% for health effects and 3% for costs. Discounting is typically done by presenting the costs and health outcomes as a stream of values over time and applying a discounting factor based on the discount rate to each value, and then aggregating them to obtain the ‘present value’ of each stream. The discount factor is increasing over time, based on the underlying fixed discount rate. 

*Text adapted from Dutch costing manual and Discount Rate [online]. (2016). York; York Health Economics Consortium; 2016. <https://yhec.co.uk/glossary/discount-rate/>.*

## Formulas

The most common method is to calculate a net present value based on constant discounting.

When taking costs as an example, the present value of costs ($C$) from the current year ($t=0$) up to and including year $n$ under a constant discounting model is:

$$
C \;=\; \sum_{t=0}^{n} \frac{K_t}{(1+i)^{t}}
$$

where $K_t$ denotes the costs in year $t$ and $i$ is the constant discount rate.\
No discounting is applied at $t=0$.

Please note that the net present value for costs, $C$, could also be the net present value of an health effect, e.g. QALYs.

## Difference between `discount_value()` and `discount_stream()`

`discount_value()` converts a single future value (cost or health effect) at time `t` to its present value using the approriate discount rate (default is Dutch Guidelines values). Use it when you have one payment or health outcome occurring in a specific year.

`discount_stream()` converts a *vector* of values (costs or health effects) occurring at multiple times to a single present value by discounting each element and aggregating.

## R example from guidelines

In an economic evaluation annual costs for standard of care (SoC) are estimated to be €100.00. Without discounting, the total costs after 3 years are €300.00.

```{r no-discount}
c_annual <- 100
c_t3_undiscounted <- 3 * c_annual
c_t3_undiscounted
```

Based on the annual costs, we make a vector of these costs for the three years. 
```{r discount-rate}
v_c_SoC <- rep(c_annual, 3) # Vector/stream of costs values on all years for standard of care 
names(v_c_SoC) <- c("Year 1", "Year 2", "Year 3")
```


This example is a stream of costs, therefore, we need the function `discount_stream`. Using the formulate this gives us:
```{r example-guideline}
discount_stream(values = v_c_SoC, discount_rate = "costs")
```
Please NOTE: The discount rate for costs in the Netherlands is 3% and is the default discount rate in the functions. 

You can sum these values using the basic sum function or set the argument `aggregate` to `TRUE`

```{r example-guideline}
sum(discount_stream(values = v_c_SoC, discount_rate = "costs"))
discount_stream(    values = v_c_SoC, discount_rate = "costs", aggregate = TRUE)
```

## R example with discount value

If we like to only discount the annual costs at time year 3. We can use `discount_value`

```{r example-value}
discount_value(value = 100, discount_rate = "costs", year = 3)
```

## R example for health effects
As discussed before, the same applies to health effects, in this example QALYs. Where over a four year period an individual is expected to life a perfect life and each year 1 QALY is accrued. 

```{r example-discount-stream-QALY}
discount_stream(value = c(1, 1, 1, 1), discount_rate = "effects")
```


# Discounting of the first cycle
As you might have noticed, the first cycle is not discounted by default. This is in line with the Dutch guidelines that recommend not to discount the first cycle. Therefore, functions provided in this package skip discounting of only the first cycle by default. Via the parameter `discount_year_one`, the analyst can decide whether to discount the initial cycle by setting it to `TRUE`.

```{r example-discount-year-one}
discount_stream(value = c(1, 1, 1, 1), discount_rate = "effects", discount_year_one = FALSE)
discount_stream(value = c(1, 1, 1, 1), discount_rate = "effects", discount_year_one = TRUE)


discount_value(value = c(1), discount_rate = "effects", year = 5, discount_year_one = TRUE)
discount_value(value = c(1), discount_rate = "effects", year = 5, discount_year_one = FALSE)

```

# Discounting in models with cycle lengths different then annual
While the discounting approach is straightforward for models with annual cycles, its application becomes ambiguous in models with sub-annual time steps, such as monthly or weekly cycles. The guideline does not specify whether **not discounting the first year** should translate to excluding only the first cycle (e.g., 1 month), or the entire first year from discounting. As a result, different interpretations exist in the modeling community. 


# Why does this matter? 
Although yearly and monthly discounting approaches produce the same total undiscounted QALYs or costs, they differ in discounted values due to when outcomes are assumed to occur. In annual models, outcomes are often assumed to occur at the end of the year, while in sub-annual models the rewards are typically accrued more evenly across time. This leads to slightly higher present values in the latter (sub-annual), as benefits (or costs) occur earlier and are therefore less discounted.

```{r demo-difference}
values = c(1, 1, 1, 1)            # 1 QALY per year
discount_rate = 0.015             # 3% annual discount rate
t_year <- seq_along(values)       # Time: 1, 2, 3, 4
discounted_values <- values * (1 + discount_rate)^(-t_year)
sum(discounted_values)            # ~3.7171

discount_stream(values = values, discount_rate = "effects", aggregate = T, discount_year_one = T)


```

# Our approach
Since discounting relate to the fundamental principle that costs and benefits should be discounted beyond the present, we interpret every time point after the first cycle (present) as future. Therefore, in our code we exclude only the first cycle from discounting, regardless of its length. However, this design choice has practical implications that might not be in line with the desired way of coding for all modelers and we therefore, demonstrate how to adjust the code in case other modelling assumptions are desired. 

## 
For demonstration purposes we will make use of the Sick-Sicker example 
```{r exmple-sick-sicker}
data("data_model_output_sick_sicker") # Load the data 

# Use the annual model
l_m_M_annual[["Standard of care"]]

# Apply the utilities
v_Q_SoC <- l_m_M_annual[["Standard of care"]] %*% l_u_annual[["Standard of care"]]
sum(v_Q_SoC) # get the undiscounted QALYs

# Apply discounting
discount_stream(v_Q_SoC, discount_rate = "effects", discount_year_one = FALSE, cycle_length_in_years = 1, aggregate = T) # This gives the discounted QALYs



```


# Discussion
Weird to have non-annual cycles, but give the cycles annual?
What if you only dont disocunt hte first year but all after 

[cycle lengt adjustment ]

For some Cite Attema, Claxton 2018 paper




## Input validation & common messages

## Error messages you might see

-   **"Year out of range …"**\
    You asked for a year outside `range(df_fp$Year)`. Use a valid year or pass `NULL` for all years.

-   **"For `output = "value"`, provide exactly one `year` and a single (units, avg) combination."**\
    Single value mode needs exactly one year **and** one `(units, avg)`.

